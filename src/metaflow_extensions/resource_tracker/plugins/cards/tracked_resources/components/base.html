<html>
<head>
    <script type="text/javascript">{{{dygraphs_js}}}</script>
    <script type="text/javascript">{{{dygraphs_crosshair_js}}}</script>
    <script type="text/javascript">{{{dygraphs_synchronizer_js}}}</script>
    <style type="text/css">{{{dygraphs_css}}}</style>
    <script type="text/javascript">{{{helpers_js}}}</script>
    <style type="text/css">{{{custom_css}}}</style>
</head>
<body>
    <div style="display: flex; gap: 1rem;">
        <div id="server" class="section" style="flex: 0.6;">
            <h1>
                <div class="header-icon">
                    {{{icon_motherboard}}}
                </div>
                <div class="header-text">
                    <div class="title">Server</div>
                    <p class="description">Most important hardware information about the server.</p>
                </div>
            </h1>
            <div class="section-content">
                <div class="section-content-cards">
                    <div class="section-content-card">
                        <div class="section-content-card-label">vCPUs</div>
                        <div class="section-content-card-value">{{{server_info.vcpus}}}</div>
                    </div>
                    <div class="section-content-card">
                        <div class="section-content-card-label">Memory</div>
                        <div class="section-content-card-value">{{{server_info.memory_mb}}} MB</div>
                    </div>
                    <div class="section-content-card">
                        <div class="section-content-card-label">GPUs</div>
                        <div class="section-content-card-value">{{{server_info.gpu_count}}}</div>
                    </div>
                    <div class="section-content-card">
                        <div class="section-content-card-label">VRAM</div>
                        <div class="section-content-card-value">{{{server_info.gpu_memory_mb}}} MB</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="provider" class="section" style="flex: 0.4;">
            <h1>
                <div class="header-icon">
                    {{{icon_clouds}}}
                </div>
                <div class="header-text">
                    <div class="title">Cloud</div>
                    <p class="description">The identified cloud provider, region, and instance type used for this step.</p>
                </div>
            </h1>
            <div class="section-content">
                <div class="section-content-cards">
                    <div class="section-content-card">
                        <div class="section-content-card-label">Cloud Provider</div>
                        <div class="section-content-card-value">{{{cloud_info.vendor}}}</div>
                    </div>
                    <div class="section-content-card">
                        <div class="section-content-card-label">Region/Datacenter</div>
                        <div class="section-content-card-value">{{{cloud_info.region}}}</div>
                    </div>
                    <div class="section-content-card">
                        <div class="section-content-card-label">Instance Type</div>
                        <div class="section-content-card-value">{{{cloud_info.instance_type}}}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div style="display: flex; gap: 1rem;">
        <div id="stats" class="section" style="flex: 0.6;">
            <h1>
                <div class="header-icon">
                    {{{icon_calculator}}}
                </div>
                <div class="header-text">
                    <div class="title">Usage Statistics</div>
                    <p class="description">Current and historical (last successful 5 runs) averages and peaks for CPU and memory usage.</p>
                </div>
            </h1>
            <div class="section-content">
                <div class="section-content-cards">
                    <div class="section-content-card-task">
                        <div class="section-content-card-label">CPU Usage</div>
                        <div class="section-content-card-value">
                            <span class="metric-highlight">{{{stats.cpu_usage.mean}}}</span> avg
                            <span class="metric-separator">|</span>
                            <span class="metric">{{{historical_stats.avg_cpu_mean}}}</span> hist avg
                            <span class="metric-separator">|</span>
                            <span class="metric">{{{stats.cpu_usage.max}}}</span> peak</div>
                    </div>
                    <div class="section-content-card-task">
                        <div class="section-content-card-label">Memory Usage</div>
                        <div class="section-content-card-value">
                            <span class="metric">{{{stats.memory_usage.mean_pretty}}} MiB</span> avg
                            <span class="metric-separator">|</span>
                            <span class="metric">{{{stats.memory_usage.max_pretty}}} MiB</span> peak
                            <span class="metric-separator">|</span>
                            <span class="metric-highlight">{{{historical_stats.avg_memory_max_pretty}}} MiB</span> hist peak</div>
                    </div>
                    <div class="section-content-card-task">
                        <div class="section-content-card-label">Duration</div>
                        <div class="section-content-card-value">{{{stats.duration}}} sec</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="recommendations" class="section" style="flex: 0.4;">
            <h1>
                <div class="header-icon">
                    {{{icon_robot}}}
                </div>
                <div class="header-text">
                    <div class="title">Recommendations</div>
                    <p class="description">TODO</p>
                </div>
            </h1>
            <div class="section-content">
                <!-- TODO CTA @resources recommendation -->
                <!-- TODO CTA interested in auto-tuning? -->
            </div>
        </div>
    </div>
    <div id="cpu" class="section">
        <h1 class="section-header">
            <div class="header-icon">
                {{{icon_cpu}}}
            </div>
            <div class="header-text">
                <div class="title">CPU Usage</div>
                <p class="description">Both the server and task-specific CPU usage is measured by summing up the user+nice and system CPU times (in clock ticks), normalized to utilized CPU count by dividing by the total elapsed time * ticks per second. Task CPU usage includes all children processes.</p>
            </div>
            <div id="labels_cpu" class="labels"></div>
        </h1>
        <div class="plot-container">
            <div id="plot_cpu" class="plot"></div>
        </div>
    </div>
    <div id="mem" class="section">
        <h1 class="section-header">
            <div class="header-icon">
                {{{icon_memory}}}
            </div>
            <div class="header-text">
                <div class="title">Memory Usage</div>
                <p class="description">The server's application memory usage is tracked via the size of anonymous memory pages, while task memory usage measured by summing up all Proportional Set Size (PSS) rollups of all subprocesses.</p>
            </div>
            <div id="labels_mem" class="labels"></div>
        </h1>
        <div class="plot-container">
            <div id="plot_mem" class="plot"></div>
        </div>
    </div>
    <div id="disk" class="section">
        <h1 class="section-header">
            <div class="header-icon">
                {{{icon_disk}}}
            </div>
            <div class="header-text">
                <div class="title">Disk Usage</div>
                <p class="description">Tracking task-specific disk usage is highly unreliable, so monitoring the disk usage at the server level is recommended, which includes all disks mounted on the system.</p>
            </div>
            <div id="labels_disk" class="labels"></div>
        </h1>
        <div class="plot-container">
            <div id="plot_disk" class="plot"></div>
        </div>
    </div>
    <div id="net" class="section">
        <h1 class="section-header">
            <div class="header-icon">
                {{{icon_router}}}
            </div>
            <div class="header-text">
                <div class="title">Network Usage</div>
                <p class="description">Network usage is only tracked at the server level on all interfaces.</p>
            </div>
            <div id="labels_net" class="labels"></div>
        </h1>
        <div class="plot-container">
            <div id="plot_net" class="plot"></div>
        </div>
    </div>
    <script type="text/javascript">
        Dygraph.onDOMready(function onDOMready() {
            var cpuGraph = createGraph("plot_cpu", `{{{csv_cpu}}}`, 'labels_cpu'),
                memGraph = createGraph("plot_mem", `{{{csv_mem}}}`, 'labels_mem', { labelsKMG2: true }),
                diskGraph = createGraph("plot_disk", `{{{csv_disk}}}`, 'labels_disk',
                    {
                        labelsKMG2: true,
                        series: {
                            "Task disk write": {strokePattern: [7, 3], color: '#34D399'},
                            "Server disk write": {strokePattern: [7, 3], color: '#38BDF8'},
                            "Task disk read": {strokePattern: null, color: '#34D399'},
                            "Server disk read": {strokePattern: null, color: '#38BDF8'}
                        },
                    }),
                netGraph = createGraph("plot_net", `{{{csv_net}}}`, 'labels_net',
                    {
                        labelsKMG2: true,
                        series: {
                            "Inbound network traffic": {strokePattern: null, color: '#38BDF8'},
                            "Outbound network traffic": {strokePattern: [7, 3], color: '#38BDF8'},
                        },
                    });
            var sync = Dygraph.synchronize([cpuGraph, memGraph, diskGraph, netGraph], {zoom: true, selection: true, range: false});
        });
    </script>
</body>
</html>